<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ASTEC GPAO - Planning Adaptatif</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --weekend: #e8f5e9; --ferie: #fce4ec; --pont: #fff9c4; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 20px; background: #f4f7f6; }

        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 15px; }

        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: 600; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-grey { background: #7f8c8d; }
        .btn-orange { background: #e67e22; }

        #date-display { font-weight: bold; font-size: 1.2em; min-width: 220px; text-align: center; color: var(--primary); }

        /* L√©gende */
        .legend-bar { display: flex; gap: 20px; background: white; padding: 10px 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.85em; align-items: center; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .box { width: 14px; height: 14px; border: 1px solid #ddd; border-radius: 3px; }

        /* Table & Gantt */
        .gantt-container { background: white; padding: 15px; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { border-collapse: collapse; width: max-content; min-width: 100%; position: relative; }
        th, td { border: 1px solid #ddd; padding: 0; text-align: center; vertical-align: middle; position: relative; }

        .col-day { width: 50px; min-width: 50px; height: 45px; }
        .weekend { background: var(--weekend) !important; }
        .ferie { background: var(--ferie) !important; }
        .pont { background: var(--pont) !important; }

        .col-fixed { position: sticky; left: 0; background: #fff; width: 350px; text-align: left; z-index: 30; border-right: 4px solid var(--primary); padding: 8px 15px; }
        .row-p { background: #f1f3f5; font-weight: bold; cursor: pointer; }
        .task-name { cursor: pointer; color: var(--accent); text-decoration: underline; }

        /* Barre de t√¢che adaptative */
        .task-bar {
            position: absolute; top: 4px; left: 2px; height: calc(100% - 8px);
            z-index: 10; border-radius: 4px; color: white;
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 3px; padding: 4px;
            font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            box-sizing: border-box; cursor: pointer;
        }
        .task-bar.selected { outline: 3px solid rgba(52, 152, 219, 0.8); z-index: 20; }

        .staff-tag { padding: 1px 4px; border-radius: 2px; white-space: nowrap; color: white; border: 1px solid rgba(255,255,255,0.3); font-size: 9px; }
        .staff-atelier { background: #7f8c8d !important; } 
        .staff-client { background: #e67e22 !important; }

        /* Resize handles */
        .resize-handle { position: absolute; top: 0; width: 8px; height: 100%; cursor: ew-resize; z-index: 25; }
        .resize-handle.left { left: 0; }
        .resize-handle.right { right: 0; }

        /* Pop-up Double Clic */
        .quick-edit-modal { 
            position: absolute; background: white; border-radius: 8px; padding: 15px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3); z-index: 2000; min-width: 250px; border: 1px solid #ccc;
        }

        .modal { display: none; position: fixed; z-index: 1000; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 400px; display: flex; flex-direction: column; gap: 12px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header">
    <h1>ASTEC GPAO</h1>
    <div class="controls">
        <button class="btn-blue" onclick="changeMonth(-1)">‚óÄ Pr√©c√©dent</button>
        <div id="date-display">...</div>
        <button class="btn-blue" onclick="changeMonth(1)">Suivant ‚ñ∂</button>
        <button class="btn-green" onclick="openModalP()">+ Projet</button>
        <button class="btn-blue" onclick="newTask()">+ T√¢che</button>
        <button style="background: #9b59b6;" onclick="showModal('modalPerso')">üë• Param√®tres</button>
        <div style="margin-left: auto;">
            <input type="text" id="search-affaire" placeholder="üîç N¬∞ Affaire..." onkeyup="searchProject()">
        </div>
    </div>
</div>

<div class="legend-bar">
    <div class="legend-item"><div class="box" style="background: var(--weekend);"></div> Week-end</div>
    <div class="legend-item"><div class="box" style="background: var(--ferie);"></div> F√©ri√©</div>
    <div class="legend-item"><div class="box" style="background: var(--pont);"></div> Pont</div>
    <div style="width:20px"></div>
    <div class="legend-item"><div class="box staff-atelier"></div> Atelier (Gris)</div>
    <div class="legend-item"><div class="box staff-client"></div> Site (Orange)</div>
</div>

<div class="gantt-container" id="gantt-table"></div>

<div id="modalP" class="modal"><div class="modal-content">
    <h3 id="modalP_title">Projet</h3>
    <input type="hidden" id="edit_proj_id">
    <input type="text" id="p_aff" placeholder="N¬∞ Affaire">
    <input type="text" id="p_cli" placeholder="Client">
    <button class="btn-green" onclick="saveProject()">Enregistrer</button>
    <button class="btn-red" onclick="delProject()">Supprimer</button>
    <button class="btn-grey" onclick="hideModal('modalP')">Fermer</button>
</div></div>

<div id="modalT" class="modal"><div class="modal-content">
    <h3 id="modalT_title">T√¢che</h3>
    <input type="hidden" id="edit_task_id">
    <select id="t_proj_sel"></select>
    <input type="text" id="t_name" placeholder="D√©signation">
    <div style="display:flex; gap:10px;">
        <input type="date" id="t_start">
        <input type="number" id="t_dur" value="1" min="1" style="width:70px">
    </div>
    <button class="btn-blue" onclick="saveTask()">Enregistrer</button>
    <button id="btn_del_task" class="btn-red" onclick="delTask()">Supprimer</button>
    <button class="btn-grey" onclick="hideModal('modalT')">Annuler</button>
</div></div>

<div id="modalPerso" class="modal"><div class="modal-content">
    <h3>Configuration</h3>
    <div id="staff-list" style="max-height: 100px; overflow-y: auto; border: 1px solid #eee;"></div>
    <div style="display:flex; gap:5px;"><input type="text" id="new_staff" placeholder="Nom" style="flex:1"><button class="btn-green" onclick="addStaff()">+</button></div>
    <hr>
    <div id="pont-list" style="max-height: 80px; overflow-y: auto; border: 1px solid #eee;"></div>
    <div style="display:flex; gap:5px;"><input type="date" id="new_pont_date" style="flex:1"><button class="btn-orange" onclick="addPont()">+ Pont</button></div>
    <button class="btn-grey" onclick="hideModal('modalPerso')">Fermer</button>
</div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAGziDYYX7R-3MV5UX3UO4xy8iwWdOkgI8",
        authDomain: "astec-gpao.firebaseapp.com",
        databaseURL: "https://astec-gpao-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "astec-gpao",
        storageBucket: "astec-gpao.firebasestorage.app",
        messagingSenderId: "1042124006828",
        appId: "1:1042124006828:web:4ea7c467137cf4886b4609"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'astec_gpao_data');

    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            window.state = data;
            if (!window.state.projects) window.state.projects = [];
            if (!window.state.tasks) window.state.tasks = [];
            if (!window.state.staff) window.state.staff = [];
            if (!window.state.ponts) window.state.ponts = [];
            render();
        }
    });

    window.saveToFirebase = function() { set(dbRef, window.state); };
</script>

<script>
    window.state = { projects: [], tasks: [], staff: [], ponts: [] };
    let viewDate = new Date(); viewDate.setDate(1);
    let selectedTaskId = null;
    let isResizing = false;
    let resizeData = null;
    let quickEditModal = null;
    let searchFilter = null;

    function formatDateKey(date) {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function getFeries(year) {
        const paques = (y) => {
            const a = y % 19, b = Math.floor(y / 100), c = y % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451), n = Math.floor((h + l - 7 * m + 114) / 31), p = (h + l - 7 * m + 114) % 31;
            return new Date(y, n - 1, p + 1);
        };
        const p = paques(year);
        const lP = new Date(p); lP.setDate(p.getDate() + 1);
        const asc = new Date(p); asc.setDate(p.getDate() + 39);
        const lPent = new Date(p); lPent.setDate(p.getDate() + 50);
        let f = {
            [`${year}-01-01`]: "An", [`${year}-05-01`]: "Travail", [`${year}-05-08`]: "1945",
            [`${year}-07-14`]: "National", [`${year}-08-15`]: "Assompt.", [`${year}-11-01`]: "Toussaint",
            [`${year}-11-11`]: "Armist.", [`${year}-12-25`]: "No√´l",
            [formatDateKey(lP)]: "P√¢ques", [formatDateKey(asc)]: "Ascens.", [formatDateKey(lPent)]: "Pentec."
        };
        if (window.state.ponts) window.state.ponts.forEach(date => { f[date] = "PONT"; });
        return f;
    }

    function isWorkingDay(date, feries) {
        const day = date.getDay();
        return day !== 0 && day !== 6 && !feries[formatDateKey(date)];
    }

    function addBusinessDays(startDate, days) {
        let d = new Date(startDate);
        let c = 0;
        const feries = getFeries(d.getFullYear());
        while (c < days) {
            if (isWorkingDay(d, feries)) c++;
            if (c < days) d.setDate(d.getDate() + 1);
        }
        return formatDateKey(d);
    }

    function countBusinessDays(start, end) {
        let count = 0, current = new Date(start), endDate = new Date(end);
        const feries = getFeries(current.getFullYear());
        while (current <= endDate) {
            if (isWorkingDay(current, feries)) count++;
            current.setDate(current.getDate() + 1);
        }
        return count;
    }

    function addWorkingDays(date, delta, feries) {
        let d = new Date(date);
        let count = 0;
        const direction = delta > 0 ? 1 : -1;
        const target = Math.abs(delta);
        while (count < target) {
            d.setDate(d.getDate() + direction);
            if (isWorkingDay(d, feries)) count++;
        }
        return d;
    }

    // ACTIONS CLIC
    function selectTask(taskId, event) {
        event.stopPropagation();
        closeQuickEdit();
        selectedTaskId = (selectedTaskId === taskId) ? null : taskId;
        render();
    }

    function onTaskDoubleClick(taskId, event) {
        event.stopPropagation();
        closeQuickEdit();
        const task = window.state.tasks.find(t => t.id === taskId);
        
        const modal = document.createElement('div');
        modal.className = 'quick-edit-modal';
        modal.style.left = Math.min(event.pageX, window.innerWidth - 280) + 'px';
        modal.style.top = event.pageY + 'px';

        let html = `<h4>${task.name}</h4>`;
        html += `<div style="margin-bottom:10px;"><label style="font-size:11px; font-weight:bold;">Lieu :</label><br>
            <input type="radio" name="q_loc" value="atelier" ${task.location==='atelier'?'checked':''} onchange="updateQuick(${taskId},'location','atelier')"> Atelier 
            <input type="radio" name="q_loc" value="client" ${task.location==='client'?'checked':''} onchange="updateQuick(${taskId},'location','client')"> Site</div>`;
        
        html += `<label style="font-size:11px; font-weight:bold;">Personnel :</label><div style="max-height:120px; overflow-y:auto; border:1px solid #ddd; padding:5px; margin-top:5px;">`;
        window.state.staff.forEach(s => {
            const checked = (task.staff || []).includes(s) ? 'checked' : '';
            html += `<div style="font-size:12px;"><input type="checkbox" ${checked} onchange="toggleQuickStaff(${taskId}, '${s}', this.checked)"> ${s}</div>`;
        });
        html += `</div><button class="btn-blue" style="width:100%; margin-top:10px;" onclick="closeQuickEdit()">Fermer</button>`;
        
        modal.innerHTML = html;
        document.body.appendChild(modal);
        quickEditModal = modal;
        setTimeout(() => document.addEventListener('click', closeQuickEdit), 10);
    }

    function updateQuick(id, field, val) { const t = window.state.tasks.find(x => x.id === id); t[field] = val; saveToFirebase(); render(); }
    function toggleQuickStaff(id, name, check) {
        const t = window.state.tasks.find(x => x.id === id);
        if(!t.staff) t.staff = [];
        if(check) { if(!t.staff.includes(name)) t.staff.push(name); }
        else { t.staff = t.staff.filter(s => s !== name); }
        saveToFirebase(); render();
    }
    function closeQuickEdit() { if(quickEditModal) { quickEditModal.remove(); quickEditModal = null; } }

    // RESIZE
    function startResize(taskId, direction, event) {
        event.stopPropagation();
        isResizing = true;
        const task = window.state.tasks.find(t => t.id === taskId);
        resizeData = { taskId, direction, startX: event.pageX, originalStart: new Date(task.start), originalEnd: new Date(task.end), lastDelta: 0 };
        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', endResize);
    }

    function handleResize(event) {
        if (!isResizing || !resizeData) return;
        const deltaX = event.pageX - resizeData.startX;
        const daysDelta = Math.round(deltaX / 50);
        if (daysDelta === resizeData.lastDelta) return;
        resizeData.lastDelta = daysDelta;
        const task = window.state.tasks.find(t => t.id === resizeData.taskId);
        const feries = getFeries(new Date(task.start).getFullYear());
        if (resizeData.direction === 'left') {
            let newStart = addWorkingDays(resizeData.originalStart, daysDelta, feries);
            if (newStart < new Date(task.end)) { task.start = formatDateKey(newStart); task.duration = countBusinessDays(newStart, new Date(task.end)); }
        } else {
            let newEnd = addWorkingDays(resizeData.originalEnd, daysDelta, feries);
            if (newEnd > new Date(task.start)) { task.end = formatDateKey(newEnd); task.duration = countBusinessDays(new Date(task.start), newEnd); }
        }
        render();
    }

    function endResize() { if (isResizing) { isResizing = false; resizeData = null; document.removeEventListener('mousemove', handleResize); document.removeEventListener('mouseup', endResize); saveToFirebase(); } }

    // MODALS
    function openModalP(id = null) {
        const p = id ? window.state.projects.find(x => x.id === id) : null;
        document.getElementById('edit_proj_id').value = id || "";
        document.getElementById('p_aff').value = p ? p.aff : "";
        document.getElementById('p_cli').value = p ? p.cli : "";
        showModal('modalP');
    }
    function saveProject() {
        const id = document.getElementById('edit_proj_id').value;
        const data = { aff: document.getElementById('p_aff').value, cli: document.getElementById('p_cli').value };
        if(id) { let idx = window.state.projects.findIndex(x => x.id === parseInt(id)); window.state.projects[idx] = { ...window.state.projects[idx], ...data }; }
        else { window.state.projects.push({ id: Date.now(), ...data, color: `hsl(${Math.random()*360}, 65%, 45%)` }); }
        saveToFirebase(); hideModal('modalP');
    }
    function delProject() { if(confirm("Supprimer ?")) { window.state.projects = window.state.projects.filter(p => p.id !== parseInt(document.getElementById('edit_proj_id').value)); saveToFirebase(); hideModal('modalP'); } }

    function newTask() {
        updateSelectors();
        document.getElementById('edit_task_id').value = "";
        document.getElementById('t_name').value = "";
        document.getElementById('t_start').value = formatDateKey(new Date());
        showModal('modalT');
    }
    function editTask(id) {
        const t = window.state.tasks.find(x => x.id === id);
        updateSelectors();
        document.getElementById('edit_task_id').value = t.id;
        document.getElementById('t_name').value = t.name;
        document.getElementById('t_start').value = t.start;
        document.getElementById('t_dur').value = t.duration;
        document.getElementById('t_proj_sel').value = t.pId;
        showModal('modalT');
    }
    function saveTask() {
        const id = document.getElementById('edit_task_id').value;
        const start = document.getElementById('t_start').value;
        const dur = parseInt(document.getElementById('t_dur').value);
        const tData = {
            id: id ? parseInt(id) : Date.now(),
            pId: parseInt(document.getElementById('t_proj_sel').value),
            name: document.getElementById('t_name').value || "T√¢che",
            start: start,
            duration: dur,
            end: addBusinessDays(new Date(start), dur),
            staff: id ? window.state.tasks.find(x => x.id === parseInt(id)).staff : [],
            location: id ? window.state.tasks.find(x => x.id === parseInt(id)).location : "atelier"
        };
        if(id) window.state.tasks[window.state.tasks.findIndex(x => x.id === parseInt(id))] = tData;
        else window.state.tasks.push(tData);
        saveToFirebase(); hideModal('modalT');
    }
    function delTask() { if(confirm("Supprimer ?")) { window.state.tasks = window.state.tasks.filter(t => t.id !== parseInt(document.getElementById('edit_task_id').value)); saveToFirebase(); hideModal('modalT'); } }

    function addStaff() { let n = document.getElementById('new_staff').value.trim(); if(n) { window.state.staff.push(n); window.state.staff.sort(); saveToFirebase(); document.getElementById('new_staff').value=''; updateSelectors(); } }
    function addPont() { let d = document.getElementById('new_pont_date').value; if(d) { window.state.ponts.push(d); saveToFirebase(); updateSelectors(); render(); } }

    function updateSelectors() {
        document.getElementById('t_proj_sel').innerHTML = window.state.projects.map(p => `<option value="${p.id}">${p.aff}</option>`).join('');
        document.getElementById('staff-list').innerHTML = window.state.staff.map(s => `<div>${s}</div>`).join('');
        document.getElementById('pont-list').innerHTML = (window.state.ponts || []).map(p => `<div>${p}</div>`).join('');
    }

    function searchProject() {
        const val = document.getElementById('search-affaire').value.toLowerCase();
        searchFilter = val ? window.state.projects.filter(p => p.aff.toLowerCase().includes(val)).map(p => p.id) : null;
        render();
    }

    function render() {
        const y = viewDate.getFullYear(), m = viewDate.getMonth(), daysInM = new Date(y, m + 1, 0).getDate(), feries = getFeries(y);
        document.getElementById('date-display').innerText = viewDate.toLocaleDateString('fr-FR', {month:'long', year:'numeric'}).toUpperCase();
        
        let rowDays = `<tr><th class="col-fixed">Affaire / Client / Site</th>`;
        for(let d=1; d<=daysInM; d++) {
            let dt = new Date(y, m, d), ds = formatDateKey(dt), isF = feries[ds], isW = (dt.getDay()===0||dt.getDay()===6), isP = (isF === "PONT");
            rowDays += `<th class="col-day ${isW?'weekend':''} ${isP?'pont':(isF?'ferie':'')}"><div style="font-size:9px">${dt.toLocaleDateString('fr-FR',{weekday:'short'})}</div>${d}</th>`;
        }
        
        let html = `<table><thead>${rowDays}</tr></thead><tbody>`;
        let projs = window.state.projects;
        if(searchFilter) projs = projs.filter(p => searchFilter.includes(p.id));

        projs.forEach(p => {
            html += `<tr class="row-p" onclick="openModalP(${p.id})"><td class="col-fixed"><b>${p.aff} ‚Äî ${p.cli}</b></td><td colspan="${daysInM}"></td></tr>`;
            window.state.tasks.filter(t => t.pId === p.id).forEach(t => {
                html += `<tr><td class="col-fixed" style="padding-left:25px;"><span class="task-name" onclick="event.stopPropagation(); editTask(${t.id})">${t.name}</span></td>`;
                
                const taskStart = new Date(t.start);
                const taskEnd = new Date(t.end);
                const staffClass = t.location === 'client' ? 'staff-client' : 'staff-atelier';

                for(let d=1; d<=daysInM; d++) {
                    let cur = new Date(y, m, d), ds = formatDateKey(cur), isF = feries[ds], isW = (cur.getDay()===0||cur.getDay()===6), isP = (isF==="PONT");
                    let content = "";
                    
                    // On ne dessine la barre que sur le premier jour ouvr√© de la t√¢che rencontr√© dans le mois
                    if (cur.toDateString() === taskStart.toDateString() || (cur.getDate() === 1 && cur <= taskEnd && cur >= taskStart)) {
                        // Calcul de la largeur
                        let displayEnd = new Date(Math.min(taskEnd, new Date(y, m, daysInM)));
                        let displayStart = new Date(Math.max(taskStart, new Date(y, m, 1)));
                        let widthDays = Math.ceil((displayEnd - displayStart) / 86400000) + 1;
                        
                        content = `<div class="task-bar ${selectedTaskId===t.id?'selected':''}" 
                                     style="background:${p.color}; width:${widthDays * 50 - 4}px;" 
                                     onclick="selectTask(${t.id}, event)" 
                                     ondblclick="onTaskDoubleClick(${t.id}, event)">
                                     <div class="resize-handle left" onmousedown="startResize(${t.id},'left',event)"></div>
                                     <div style="display:flex; flex-wrap:wrap; gap:2px; pointer-events:none;">
                                        ${(t.staff||[]).map(s=>`<span class="staff-tag ${staffClass}">${s}</span>`).join('')}
                                     </div>
                                     <div class="resize-handle right" onmousedown="startResize(${t.id},'right',event)"></div>
                                   </div>`;
                    }
                    html += `<td class="col-day ${isW?'weekend':''} ${isP?'pont':(isF?'ferie':'')}">${content}</td>`;
                }
                html += `</tr>`;
            });
        });
        document.getElementById('gantt-table').innerHTML = html + `</tbody></table>`;
    }

    function showModal(id) { updateSelectors(); document.getElementById(id).style.display = 'flex'; }
    function hideModal(id) { document.getElementById(id).style.display = 'none'; }
    function changeMonth(n) { viewDate.setMonth(viewDate.getMonth() + n); render(); }

    render();
</script>
</body>
</html>

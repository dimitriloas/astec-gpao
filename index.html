<!DOCTYPE html>
<html lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>ASTEC GPAO - Cloud Collaborative</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --weekend: #e8f5e9; --ferie: #fce4ec; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 20px; background: #f4f7f6; }

        .header { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 15px; }

        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; font-weight: 600; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn-grey { background: #7f8c8d; }
        .btn-orange { background: #e67e22; }
        .btn-small { padding: 5px 10px; font-size: 0.85em; }

        #date-display { font-weight: bold; font-size: 1.2em; min-width: 220px; text-align: center; color: var(--primary); }

        .gantt-container { background: white; padding: 15px; border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 400px; }
        table { border-collapse: collapse; width: max-content; min-width: 100%; position: relative; }
        th, td { border: 1px solid #ddd; padding: 0; text-align: center; min-height: 45px; }

        .col-day { width: 50px; min-width: 50px; height: 50px; position: relative; }
        .sep-lundi { border-left: 3px solid #bdc3c7 !important; }
        .weekend { background: var(--weekend) !important; }
        .ferie { background: var(--ferie) !important; }

        .ferie-header-name { font-size: 10px; color: #d81b60; font-weight: bold; line-height: 1; padding: 2px; }

        .col-fixed {
            position: sticky; left: 0; background: #fff; width: 400px;
            text-align: left; z-index: 20; border-right: 5px solid var(--primary);
            padding: 8px 15px;
        }

        .proj-name { cursor: pointer; color: var(--primary); text-decoration: none; }
        .proj-name:hover { color: var(--accent); text-decoration: underline; }
        .task-name { cursor: pointer; color: var(--accent); text-decoration: underline; font-weight: bold; }

        .row-p { background: #e9ecef; font-weight: bold; }
        .task-bar-cell { position: relative; padding: 0 !important; vertical-align: top; }
        .task-bar {
            position: absolute; top: 2px; left: 2px; z-index: 10; border-radius: 4px;
            color: white; display: flex; flex-direction: column; gap: 2px; padding: 4px;
            font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            overflow: hidden; box-sizing: border-box;
            cursor: pointer;
            pointer-events: auto;
            transition: box-shadow 0.2s;
        }

        .task-bar:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .task-bar.selected {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.5);
            z-index: 15;
        }

        .staff-tag { background: rgba(255,255,255,0.25); padding: 1px 5px; border-radius: 2px; white-space: nowrap; }

        .resize-handle {
            position: absolute;
            top: 0;
            width: 8px;
            height: 100%;
            cursor: ew-resize;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-bar.selected .resize-handle {
            opacity: 1;
            background: rgba(255,255,255,0.3);
        }

        .resize-handle:hover {
            background: rgba(255,255,255,0.5) !important;
        }

        .resize-handle.left { left: 0; border-radius: 4px 0 0 4px; }
        .resize-handle.right { right: 0; border-radius: 0 4px 4px 0; }

        .modal { display: none; position: fixed; z-index: 100; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 450px; display: flex; flex-direction: column; gap: 12px; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

        .checkbox-container { display: flex; align-items: center; gap: 8px; }
        .checkbox-container input[type="checkbox"] { width: auto; }

        /* Liste du personnel avec bouton supprimer */
        .staff-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .staff-item:hover {
            background: #f8f9fa;
        }

        /* Quick edit modal */
        .quick-edit-modal {
            position: absolute;
            background: white;
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 200;
            min-width: 250px;
        }

        .quick-edit-modal h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
        }

        .staff-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }

        .staff-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .no-tasks-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }

        /* STYLES D'IMPRESSION */
        @media print {
            @page { size: A3 landscape; margin: 10mm; }
            body { margin: 0; padding: 0; background: white; }
            .header, .controls, .no-print { display: none !important; }
            .gantt-container { padding: 0; box-shadow: none; overflow: visible; }
            .col-fixed { position: relative; border-right: 2px solid var(--primary); }
            table { page-break-inside: avoid; font-size: 11px; }
            th, td { padding: 4px 2px; }
            .col-day { width: 40px; min-width: 40px; height: 40px; }
            .task-bar { font-size: 8px; padding: 2px; }
            .staff-tag { padding: 0px 3px; font-size: 7px; }
            .print-header { display: block !important; margin-bottom: 15px; }
            .print-hide-staff .staff-tag { display: none !important; }
            .resize-handle { display: none !important; }
        }

        .print-header { display: none; font-size: 20px; font-weight: bold; text-align: center; margin-bottom: 20px; color: var(--primary); }
    </style>
</head>
<body>

<div class="header">
    <h1>ASTEC GPAO <small style="font-size: 0.4em; color: var(--success);">‚óè LIVE CLOUD</small></h1>
    <div class="controls">
        <button class="btn-blue" onclick="changeMonth(-1)">‚óÄ Pr√©c√©dent</button>
        <div id="date-display">D√âCEMBRE 2025</div>
        <button class="btn-blue" onclick="changeMonth(1)">Suivant ‚ñ∂</button>
        <button class="btn-green" onclick="openModalP()">+ Projet</button>
        <button class="btn-blue" onclick="showModal('modalT')">+ T√¢che</button>
        <button style="background: #9b59b6;" onclick="showModal('modalPerso')">üë• Personnel</button>
        <button class="btn-orange" onclick="showModal('modalPrint')">üñ®Ô∏è Imprimer PDF</button>
    </div>
</div>

<div class="print-header" id="print-header"></div>

<div class="gantt-container" id="gantt-table">
    <div class="no-tasks-message">Chargement...</div>
</div>

<div id="modalP" class="modal"><div class="modal-content">
    <h3 id="modalP_title">Nouveau Projet</h3>
    <input type="hidden" id="edit_proj_id">
    <input type="text" id="p_aff" placeholder="N¬∞ Affaire">
    <input type="text" id="p_cli" placeholder="Client">
    <input type="text" id="p_nature" placeholder="Nature">
    <input type="text" id="p_lie" placeholder="Lieu / Site">
    <div style="display:flex; gap:10px;">
        <button class="btn-green" id="btn_save_proj" style="flex:1" onclick="saveProject()">Cr√©er</button>
        <button id="btn_del_proj" class="btn-red" style="display:none" onclick="delProject()">Supprimer</button>
    </div>
    <button class="btn-grey" onclick="hideModal('modalP')">Fermer</button>
</div></div>

<div id="modalT" class="modal"><div class="modal-content">
    <h3>D√©tail T√¢che</h3>
    <input type="hidden" id="edit_task_id">
    <select id="t_proj_sel"></select>
    <input type="text" id="t_name" placeholder="D√©signation">
    <label>Personnel :</label>
    <select id="t_staff_sel" multiple style="height: 100px;"></select>
    <label>D√©but :</label><input type="date" id="t_start">
    <label>Dur√©e (jours ouvr√©s) :</label><input type="number" id="t_dur" value="1" min="1">
    <div style="display:flex; gap:10px;">
        <button class="btn-blue" style="flex:1" onclick="saveTask()">Enregistrer</button>
        <button id="btn_del_task" class="btn-red" onclick="delTask()">Supprimer</button>
    </div>
    <button class="btn-grey" onclick="hideModal('modalT')">Annuler</button>
</div></div>

<div id="modalPerso" class="modal"><div class="modal-content">
    <h3>Gestion Personnel</h3>
    <div id="staff-list" style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; margin-bottom:10px;"></div>
    <input type="text" id="new_staff" placeholder="Nom Pr√©nom">
    <button class="btn-green" onclick="addStaff()">Ajouter</button>
    <button class="btn-grey" onclick="hideModal('modalPerso')">Fermer</button>
</div></div>

<div id="modalPrint" class="modal" style="display: none;"><div class="modal-content">
    <h3>üñ®Ô∏è Imprimer au format PDF</h3>
    <label><b>S√©lectionner le projet :</b></label>
    <select id="print_proj_sel"></select>
    <label><b>Date de d√©but (4 semaines) :</b></label>
    <input type="date" id="print_start_date">
    <div class="checkbox-container">
        <input type="checkbox" id="print_show_staff" checked>
        <label for="print_show_staff"><b>Afficher les noms du personnel</b></label>
    </div>
    <button class="btn-orange" onclick="printPDF()">üìÑ G√©n√©rer PDF</button>
    <button class="btn-grey" onclick="hideModal('modalPrint')">Annuler</button>
</div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIGURATION FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAGziDYYX7R-3MV5UX3UO4xy8iwWdOkgI8",
        authDomain: "astec-gpao.firebaseapp.com",
        databaseURL: "https://astec-gpao-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "astec-gpao",
        storageBucket: "astec-gpao.firebasestorage.app",
        messagingSenderId: "1042124006828",
        appId: "1:1042124006828:web:4ea7c467137cf4886b4609"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const stateRef = ref(db, 'gpao_data');

    // --- VARIABLES D'√âTAT ---
    let state = { projects: [], tasks: [], staff: [] };
    let viewDate = new Date(); viewDate.setDate(1);
    let selectedTaskId = null;
    let isResizing = false;
    let resizeData = null;
    let quickEditModal = null;

    // --- SYNCHRONISATION TEMPS R√âEL ---
    onValue(stateRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            state = data;
            if (!state.projects) state.projects = [];
            if (!state.tasks) state.tasks = [];
            if (!state.staff) state.staff = [];
            render();
        }
    });

    // --- FONCTIONS UTILITAIRES ---
    function formatDateKey(date) {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function getFeries(year) {
        const paques = (y) => {
            const a = y % 19, b = Math.floor(y / 100), c = y % 100, d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25), g = Math.floor((b - f + 1) / 3), h = (19 * a + b - d - g + 15) % 30, i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h - k) % 7, m = Math.floor((a + 11 * h + 22 * l) / 451), n = Math.floor((h + l - 7 * m + 114) / 31), p = (h + l - 7 * m + 114) % 31;
            return new Date(y, n - 1, p + 1);
        };
        const p = paques(year);
        const lP = new Date(p); lP.setDate(p.getDate() + 1);
        const asc = new Date(p); asc.setDate(p.getDate() + 39);
        const lPent = new Date(p); lPent.setDate(p.getDate() + 50);
        return {
            [`${year}-01-01`]: "An", [`${year}-05-01`]: "Travail", [`${year}-05-08`]: "1945",
            [`${year}-07-14`]: "National", [`${year}-08-15`]: "Assompt.", [`${year}-11-01`]: "Toussaint",
            [`${year}-11-11`]: "Armist.", [`${year}-12-25`]: "No√´l",
            [formatDateKey(lP)]: "P√¢ques", [formatDateKey(asc)]: "Ascens.", [formatDateKey(lPent)]: "Pentec."
        };
    }

    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        return Math.ceil((((d - new Date(Date.UTC(d.getUTCFullYear(), 0, 1))) / 86400000) + 1) / 7);
    }

    function addBusinessDays(startDate, days) {
        let d = new Date(startDate);
        let c = 0;
        while (c < days - 1) {
            d.setDate(d.getDate() + 1);
            if (d.getDay() !== 0 && d.getDay() !== 6) c++;
        }
        return formatDateKey(d);
    }

    function countBusinessDays(start, end) {
        let count = 0;
        let current = new Date(start);
        let endDate = new Date(end);
        while (current <= endDate) {
            if (current.getDay() !== 0 && current.getDay() !== 6) count++;
            current.setDate(current.getDate() + 1);
        }
        return count;
    }

    // NOUVELLE FONCTION : V√©rifier si une t√¢che est dans le mois affich√©
    function isTaskInMonth(task, year, month) {
        const taskStart = new Date(task.start);
        const taskEnd = new Date(task.end);
        const monthStart = new Date(year, month, 1);
        const monthEnd = new Date(year, month + 1, 0);
        
        // La t√¢che chevauche le mois si elle commence avant la fin du mois ET finit apr√®s le d√©but du mois
        return taskStart <= monthEnd && taskEnd >= monthStart;
    }

    window.saveState = function() {
        set(stateRef, state);
    };

    // GESTION DE LA S√âLECTION ET INTERACTION DES T√ÇCHES
    function selectTask(taskId, event) {
        event.stopPropagation();
        closeQuickEditModal();

        if (selectedTaskId === taskId) {
            selectedTaskId = null;
        } else {
            selectedTaskId = taskId;
        }
        render();
    }

    function onTaskDoubleClick(taskId, event) {
        event.stopPropagation();
        selectedTaskId = taskId;
        showQuickEditModal(taskId, event);
    }

    function showQuickEditModal(taskId, event) {
        closeQuickEditModal();

        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;

        const modal = document.createElement('div');
        modal.className = 'quick-edit-modal';
        modal.style.left = event.pageX + 'px';
        modal.style.top = event.pageY + 'px';

        let html = `<h4>üë• Personnel affect√©</h4>`;
        state.staff.forEach(s => {
            const checked = task.staff.includes(s) ? 'checked' : '';
            html += `
                <div class="staff-checkbox">
                    <input type="checkbox" id="quick_${s}" value="${s}" ${checked} 
                           onchange="updateTaskStaff(${taskId}, this.value, this.checked)">
                    <label for="quick_${s}">${s}</label>
                </div>
            `;
        });
        html += `<button class="btn-grey" style="margin-top:10px; width:100%;" onclick="closeQuickEditModal()">Fermer</button>`;

        modal.innerHTML = html;
        document.body.appendChild(modal);
        quickEditModal = modal;

        setTimeout(() => {
            document.addEventListener('click', closeQuickEditModalOnOutsideClick);
        }, 100);
    }

    function closeQuickEditModalOnOutsideClick(event) {
        if (quickEditModal && !quickEditModal.contains(event.target)) {
            closeQuickEditModal();
        }
    }

    window.closeQuickEditModal = function() {
        if (quickEditModal) {
            quickEditModal.remove();
            quickEditModal = null;
            document.removeEventListener('click', closeQuickEditModalOnOutsideClick);
        }
    };

    window.updateTaskStaff = function(taskId, staffName, isChecked) {
        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;

        if (isChecked) {
            if (!task.staff.includes(staffName)) {
                task.staff.push(staffName);
            }
        } else {
            task.staff = task.staff.filter(s => s !== staffName);
        }

        if (task.staff.length === 0) {
            alert("Au moins une personne doit √™tre affect√©e √† la t√¢che.");
            task.staff.push(staffName);
            document.getElementById(`quick_${staffName}`).checked = true;
            return;
        }

        window.saveState();
    };

    // GESTION DU REDIMENSIONNEMENT
    window.startResize = function(taskId, direction, event) {
        event.stopPropagation();
        isResizing = true;
        
        const task = state.tasks.find(t => t.id === taskId);
        resizeData = {
            taskId: taskId,
            direction: direction,
            startX: event.pageX,
            originalStart: new Date(task.start),
            originalEnd: new Date(task.end)
        };

        document.addEventListener('mousemove', handleResize);
        document.addEventListener('mouseup', endResize);
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
    };

    function handleResize(event) {
        if (!isResizing || !resizeData) return;

        const deltaX = event.pageX - resizeData.startX;
        const daysDelta = Math.round(deltaX / 50);

        if (daysDelta === 0) return;

        const task = state.tasks.find(t => t.id === resizeData.taskId);
        if (!task) return;

        let newStart = new Date(resizeData.originalStart);
        let newEnd = new Date(resizeData.originalEnd);

        if (resizeData.direction === 'left') {
            newStart.setDate(newStart.getDate() + daysDelta);
            if (newStart >= newEnd) return;
        } else {
            newEnd.setDate(newEnd.getDate() + daysDelta);
            if (newEnd <= newStart) return;
        }

        const duration = countBusinessDays(newStart, newEnd);
        
        task.start = formatDateKey(newStart);
        task.end = formatDateKey(newEnd);
        task.duration = duration;

        render();
    }

    function endResize() {
        if (isResizing) {
            isResizing = false;
            resizeData = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', endResize);
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            window.saveState();
        }
    }

    window.render = function() {
        const y = viewDate.getFullYear(), m = viewDate.getMonth();
        const daysInM = new Date(y, m + 1, 0).getDate();
        const feries = getFeries(y);
        document.getElementById('date-display').innerText = viewDate.toLocaleDateString('fr-FR', {month:'long', year:'numeric'}).toUpperCase();

        // AM√âLIORATION : Filtrer les projets qui ont des t√¢ches dans le mois affich√©
        const visibleProjects = state.projects.filter(p => {
            const projectTasks = state.tasks.filter(t => t.pId === p.id);
            return projectTasks.some(task => isTaskInMonth(task, y, m));
        });

        let rowWeeks = `<tr><th class="col-fixed" style="background:#f8f9fa">Semaines</th>`;
        let rowFerieNames = `<tr><th class="col-fixed" style="background:#f8f9fa">Jours F√©ri√©s</th>`;
        let rowDays = `<tr><th class="col-fixed">Affaire / Client / Site</th>`;

        let weekSpan = 0;
        for(let d=1; d<=daysInM; d++) {
            let dt = new Date(y, m, d);
            let ds = formatDateKey(dt);
            let isFerie = feries[ds], isWeekend = (dt.getDay()===0||dt.getDay()===6), isMonday = (dt.getDay()===1);

            weekSpan++;
            if (dt.getDay() === 0 || d === daysInM) {
                rowWeeks += `<th colspan="${weekSpan}" style="background:#f8f9fa; font-size:0.75em; border-bottom: 2px solid var(--accent);">Sem. ${getWeekNumber(dt)}</th>`;
                weekSpan = 0;
            }
            rowFerieNames += `<th class="col-day ${isFerie ? 'ferie' : ''} ${isMonday ? 'sep-lundi' : ''}">${isFerie ? `<div class="ferie-header-name">${isFerie}</div>` : ''}</th>`;
            rowDays += `<th class="col-day ${isWeekend ? 'weekend' : ''} ${isFerie ? 'ferie' : ''} ${isMonday ? 'sep-lundi' : ''}"><div style="font-size:0.8em;">${dt.toLocaleDateString('fr-FR', {weekday:'short'}).replace('.','')}</div><div>${String(d).padStart(2,'0')}</div></th>`;
        }

        let html = `<table><thead>${rowWeeks}</tr>${rowFerieNames}</tr>${rowDays}</tr></thead><tbody>`;

        // AM√âLIORATION : Afficher uniquement les projets avec des t√¢ches dans le mois
        if (visibleProjects.length === 0) {
            html += `<tr><td colspan="${daysInM + 1}" class="no-tasks-message">Aucune t√¢che pr√©vue ce mois-ci</td></tr>`;
        } else {
            visibleProjects.forEach(p => {
                html += `<tr class="row-p">
                    <td class="col-fixed">
                        <span class="proj-name" onclick="openModalP(${p.id})"><b>${p.aff} ‚Äì ${p.cli}</b></span> | üìç ${p.lie}
                        <br><small>${p.nature || ''}</small>
                    </td>
                    <td colspan="${daysInM}"></td></tr>`;

                state.tasks.filter(t => t.pId === p.id && isTaskInMonth(t, y, m)).forEach(t => {
                    html += `<tr><td class="col-fixed" style="padding-left:30px;"><span class="task-name" onclick="editTask(${t.id})">${t.name}</span></td>`;
                    let sD = new Date(t.start), eD = new Date(t.end);
                    for(let d=1; d<=daysInM; d++) {
                        let cur = new Date(y, m, d), ds = formatDateKey(cur), content = "";
                        if (cur.toDateString() === sD.toDateString()) {
                            let diff = Math.ceil((eD - sD) / (1000 * 60 * 60 * 24)) + 1;
                            let width = Math.min(diff, daysInM - d + 1) * 50;
                            const isSelected = selectedTaskId === t.id ? 'selected' : '';
                            content = `<div class="task-bar ${isSelected}" 
                                            style="background:${p.color}; width:${width-4}px;" 
                                            onclick="selectTask(${t.id}, event)"
                                            ondblclick="onTaskDoubleClick(${t.id}, event)">
                                            <div class="resize-handle left" onmousedown="startResize(${t.id}, 'left', event)"></div>
                                            ${(t.staff || []).map(s => `<div class="staff-tag">${s}</div>`).join('')}
                                            <div class="resize-handle right" onmousedown="startResize(${t.id}, 'right', event)"></div>
                                       </div>`;
                        }
                        html += `<td class="col-day task-bar-cell ${cur.getDay()===0||cur.getDay()===6?'weekend':''} ${feries[ds]?'ferie':''} ${cur.getDay()===1?'sep-lundi':''}">${content}</td>`;
                    }
                    html += `</tr>`;
                });
            });
        }
        document.getElementById('gantt-table').innerHTML = html + `</tbody></table>`;
    };

    // D√©s√©lectionner quand on clique en dehors
    document.addEventListener('click', () => {
        if (!isResizing) {
            selectedTaskId = null;
            render();
        }
    });

    // FONCTION IMPRESSION PDF
    window.printPDF = function() {
        const projId = parseInt(document.getElementById('print_proj_sel').value);
        const startDate = new Date(document.getElementById('print_start_date').value);
        const showStaff = document.getElementById('print_show_staff').checked;
        
        if (!projId || !startDate || isNaN(startDate)) {
            alert("Veuillez s√©lectionner un projet et une date de d√©but.");
            return;
        }

        const project = state.projects.find(p => p.id === projId);
        if (!project) {
            alert("Projet introuvable !");
            return;
        }

        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 27);

        const printHtml = generatePrintTable(project, startDate, endDate, showStaff);
        
        const ganttTable = document.getElementById('gantt-table');
        const originalContent = ganttTable.innerHTML;
        
        const printHeader = document.getElementById('print-header');
        const originalHeader = printHeader.innerHTML;
        printHeader.innerHTML = `${project.aff} ‚Äì ${project.cli} | ${project.lie}<br><small style="font-size:14px;">Du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}</small>`;

        if (!showStaff) {
            document.body.classList.add('print-hide-staff');
        }

        hideModal('modalPrint');

        setTimeout(() => {
            ganttTable.innerHTML = printHtml;
            
            setTimeout(() => {
                window.print();
                
                ganttTable.innerHTML = originalContent;
                printHeader.innerHTML = originalHeader;
                document.body.classList.remove('print-hide-staff');
            }, 200);
        }, 100);
    };

    function generatePrintTable(project, startDate, endDate, showStaff) {
        if (!project) {
            console.error('Aucun projet s√©lectionn√© pour l\'impression');
            return '<p>Erreur : Aucun projet s√©lectionn√©</p>';
        }

        const days = [];
        let current = new Date(startDate);
        while (current <= endDate) {
            days.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }

        const feries = { ...getFeries(startDate.getFullYear()), ...getFeries(endDate.getFullYear()) };

        let rowWeeks = `<tr><th class="col-fixed" style="background:#f8f9fa">Semaines</th>`;
        let rowFerieNames = `<tr><th class="col-fixed" style="background:#f8f9fa">Jours F√©ri√©s</th>`;
        let rowDays = `<tr><th class="col-fixed">Affaire / Client / Site</th>`;

        let weekSpan = 0;
        days.forEach((dt, idx) => {
            let ds = formatDateKey(dt);
            let isFerie = feries[ds], isWeekend = (dt.getDay()===0||dt.getDay()===6), isMonday = (dt.getDay()===1);

            weekSpan++;
            if (dt.getDay() === 0 || idx === days.length - 1) {
                rowWeeks += `<th colspan="${weekSpan}" style="background:#f8f9fa; font-size:0.75em; border-bottom: 2px solid var(--accent);">Sem. ${getWeekNumber(dt)}</th>`;
                weekSpan = 0;
            }
            rowFerieNames += `<th class="col-day ${isFerie ? 'ferie' : ''} ${isMonday ? 'sep-lundi' : ''}">${isFerie ? `<div class="ferie-header-name">${isFerie}</div>` : ''}</th>`;
            rowDays += `<th class="col-day ${isWeekend ? 'weekend' : ''} ${isFerie ? 'ferie' : ''} ${isMonday ? 'sep-lundi' : ''}"><div style="font-size:0.8em;">${dt.toLocaleDateString('fr-FR', {weekday:'short'}).replace('.','')}</div><div>${String(dt.getDate()).padStart(2,'0')}</div></th>`;
        });

        let html = `<table><thead>${rowWeeks}</tr>${rowFerieNames}</tr>${rowDays}</tr></thead><tbody>`;

        html += `<tr class="row-p">
            <td class="col-fixed">
                <b>${project.aff} ‚Äì ${project.cli}</b> | üìç ${project.lie}
                <br><small>${project.nature || ''}</small>
            </td>
            <td colspan="${days.length}"></td></tr>`;

        const projectTasks = state.tasks.filter(t => t.pId === project.id);
        
        if (projectTasks.length === 0) {
            html += `<tr><td class="col-fixed" style="padding-left:30px; font-style:italic; color:#999;">Aucune t√¢che pour ce projet</td><td colspan="${days.length}"></td></tr>`;
        } else {
            projectTasks.forEach(t => {
                html += `<tr><td class="col-fixed" style="padding-left:30px;">${t.name}</td>`;
                let sD = new Date(t.start), eD = new Date(t.end);
                
                days.forEach((cur, idx) => {
                    let ds = formatDateKey(cur), content = "";
                    if (cur.toDateString() === sD.toDateString()) {
                        let diff = Math.ceil((eD - sD) / (1000 * 60 * 60 * 24)) + 1;
                        let width = Math.min(diff, days.length - idx) * 40;
                        let staffHTML = showStaff ? (t.staff || []).map(s => `<div class="staff-tag">${s}</div>`).join('') : '';
                        content = `<div class="task-bar" style="background:${project.color}; width:${width-4}px;">${staffHTML}</div>`;
                    }
                    html += `<td class="col-day task-bar-cell ${cur.getDay()===0||cur.getDay()===6?'weekend':''} ${feries[ds]?'ferie':''} ${cur.getDay()===1?'sep-lundi':''}">${content}</td>`;
                });
                html += `</tr>`;
            });
        }

        return html + `</tbody></table>`;
    }

    // GESTION PROJET
    window.openModalP = function(id = null) {
        const modal = document.getElementById('modalP');
        const title = document.getElementById('modalP_title');
        const btnSave = document.getElementById('btn_save_proj');
        const btnDel = document.getElementById('btn_del_proj');

        if(id) {
            const p = state.projects.find(x => x.id === id);
            title.innerText = "Modifier Projet";
            document.getElementById('edit_proj_id').value = p.id;
            document.getElementById('p_aff').value = p.aff;
            document.getElementById('p_cli').value = p.cli;
            document.getElementById('p_nature').value = p.nature || "";
            document.getElementById('p_lie').value = p.lie;
            btnSave.innerText = "Mettre √† jour";
            btnDel.style.display = "block";
        } else {
            title.innerText = "Nouveau Projet";
            document.getElementById('edit_proj_id').value = "";
            document.getElementById('p_aff').value = "";
            document.getElementById('p_cli').value = "";
            document.getElementById('p_nature').value = "";
            document.getElementById('p_lie').value = "";
            btnSave.innerText = "Cr√©er";
            btnDel.style.display = "none";
        }
        showModal('modalP');
    };

    window.saveProject = function() {
        const id = document.getElementById('edit_proj_id').value;
        const data = {
            aff: document.getElementById('p_aff').value,
            cli: document.getElementById('p_cli').value,
            nature: document.getElementById('p_nature').value,
            lie: document.getElementById('p_lie').value
        };

        if(id) {
            let idx = state.projects.findIndex(x => x.id === parseInt(id));
            state.projects[idx] = { ...state.projects[idx], ...data };
        } else {
            state.projects.push({
                id: Date.now(), ...data,
                color: `hsl(${Math.random()*360}, 65%, 45%)`
            });
        }
        window.saveState(); hideModal('modalP');
    };

    window.delProject = function() {
        const id = parseInt(document.getElementById('edit_proj_id').value);
        if(confirm("Supprimer ce projet et TOUTES ses t√¢ches ?")) {
            state.projects = state.projects.filter(x => x.id !== id);
            state.tasks = state.tasks.filter(x => x.pId !== id);
            window.saveState(); hideModal('modalP');
        }
    };

    // GESTION TACHES
    window.editTask = function(id) {
        document.getElementById('edit_task_id').value = id;
        showModal('modalT');
    };

    window.saveTask = function() {
        const id = document.getElementById('edit_task_id').value;
        const start = document.getElementById('t_start').value;
        const dur = parseInt(document.getElementById('t_dur').value);
        const staff = Array.from(document.getElementById('t_staff_sel').selectedOptions).map(o => o.value);
        if(!start || staff.length === 0) return alert("Veuillez remplir la date et le personnel.");

        const taskData = {
            id: id ? parseInt(id) : Date.now(),
            pId: parseInt(document.getElementById('t_proj_sel').value),
            name: document.getElementById('t_name').value,
            staff: staff, start: start,
            end: addBusinessDays(new Date(start), dur),
            duration: dur
        };
        if(id) { state.tasks[state.tasks.findIndex(x => x.id === parseInt(id))] = taskData; }
        else { state.tasks.push(taskData); }
        window.saveState(); hideModal('modalT');
    };

    window.delTask = function() { 
        if(confirm("Supprimer cette t√¢che ?")) { 
            state.tasks = state.tasks.filter(x => x.id !== parseInt(document.getElementById('edit_task_id').value)); 
            window.saveState(); hideModal('modalT'); 
        } 
    };

    // GESTION DU PERSONNEL
    window.addStaff = function() { 
        let n = document.getElementById('new_staff').value.trim(); 
        if(n) {
            if (state.staff.includes(n)) {
                alert("Cette personne existe d√©j√† dans la liste.");
                return;
            }
            state.staff.push(n); 
            state.staff.sort(); 
            window.saveState(); 
            document.getElementById('new_staff').value=''; 
        } 
    };

    // NOUVELLE FONCTION : Supprimer un membre du personnel
    window.deleteStaff = function(staffName) {
        // V√©rifier si ce membre est affect√© √† des t√¢ches
        const tasksWithStaff = state.tasks.filter(task => task.staff && task.staff.includes(staffName));
        
        if (tasksWithStaff.length > 0) {
            const taskNames = tasksWithStaff.map(t => `- ${t.name}`).join('\n');
            const confirmMsg = `‚ö†Ô∏è ${staffName} est affect√©(e) √† ${tasksWithStaff.length} t√¢che(s) :\n\n${taskNames}\n\nVoulez-vous vraiment supprimer cette personne ? Elle sera retir√©e de toutes les t√¢ches.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Retirer le membre de toutes les t√¢ches
            tasksWithStaff.forEach(task => {
                task.staff = task.staff.filter(s => s !== staffName);
                
                // Si la t√¢che n'a plus de personnel, la supprimer aussi
                if (task.staff.length === 0) {
                    state.tasks = state.tasks.filter(t => t.id !== task.id);
                }
            });
        } else {
            if (!confirm(`Supprimer ${staffName} de la liste du personnel ?`)) {
                return;
            }
        }
        
        // Supprimer le membre du personnel
        state.staff = state.staff.filter(s => s !== staffName);
        window.saveState();
    };

    function updateSelectors() {
        document.getElementById('t_proj_sel').innerHTML = (state.projects || []).map(p => `<option value="${p.id}">${p.aff} (${p.cli})</option>`).join('');
        document.getElementById('t_staff_sel').innerHTML = (state.staff || []).map(s => `<option value="${s}">${s}</option>`).join('');
        
        // AM√âLIORATION : Liste du personnel avec bouton de suppression
        document.getElementById('staff-list').innerHTML = (state.staff || []).map(s => `
            <div class="staff-item">
                <span>‚Ä¢ ${s}</span>
                <button class="btn-red btn-small" onclick="deleteStaff('${s}')">üóëÔ∏è Supprimer</button>
            </div>
        `).join('');
        
        document.getElementById('print_proj_sel').innerHTML = (state.projects || []).map(p => `<option value="${p.id}">${p.aff} ‚Äì ${p.cli}</option>`).join('');
        
        const today = new Date();
        document.getElementById('print_start_date').value = formatDateKey(today);
    }

    window.showModal = function(id) { 
        document.getElementById(id).style.display = 'flex'; 
        
        updateSelectors();
        
        if (id === 'modalT') {
            const editTaskId = document.getElementById('edit_task_id').value;
            
            if (!editTaskId) {
                document.getElementById('t_name').value = '';
                document.getElementById('t_start').value = '';
                document.getElementById('t_dur').value = 1;
                document.getElementById('btn_del_task').style.display = 'none';
                
                if (state.projects.length > 0) {
                    const lastProject = state.projects[state.projects.length - 1];
                    document.getElementById('t_proj_sel').value = lastProject.id;
                }
                
                const sel = document.getElementById('t_staff_sel');
                Array.from(sel.options).forEach(opt => opt.selected = false);
            } else {
                const task = state.tasks.find(t => t.id === parseInt(editTaskId));
                if (task) {
                    document.getElementById('t_proj_sel').value = task.pId;
                    document.getElementById('t_name').value = task.name;
                    document.getElementById('t_start').value = task.start;
                    document.getElementById('t_dur').value = task.duration || 1;
                    
                    const sel = document.getElementById('t_staff_sel');
                    Array.from(sel.options).forEach(opt => {
                        opt.selected = task.staff.includes(opt.value);
                    });
                    
                    document.getElementById('btn_del_task').style.display = "block";
                }
            }
        }
    };
    
    window.hideModal = function(id) {
        document.getElementById(id).style.display = 'none';
        if(id === 'modalT') document.getElementById('edit_task_id').value = "";
    };

    window.changeMonth = function(n) { viewDate.setMonth(viewDate.getMonth() + n); render(); };
    window.selectTask = selectTask;
    window.onTaskDoubleClick = onTaskDoubleClick;

    render();
</script>

</body>
</html>
